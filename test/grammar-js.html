<!doctype html>
<html>
    <head>
        
        <meta charset="utf-8">
        
        <link rel="stylesheet" href="codemirror/codemirror.css">
        <style type="text/css">
            body {
                position: relative;
            }

            .CodeMirror {
                margin: 0;
                position: relative;
                width: 100%;
                height: 100%;
                min-width:500px;
                min-height:500px;
            }
        </style>
        
        <script src="codemirror/codemirror.js"></script>
        <script src="../build/codemirror_grammar.js"></script>
        <script src="grammars/javascript.js"></script>
        
        <title>CodeMirror: Dynamic JavaScript Grammar Demo</title>
    </head>
    <body>
        
        <h3>CodeMirror: Dynamic JavaScript Grammar</h3>

<textarea id="code" name="code">
    // this is part of the CodeMirrorGrammar code itself
    
    // Codemirror Tokenizer compatible
    var getToken= function(_stream, state) {
        
        var i, token, style, stream, stack, numTokens = this.tokens.length;
        
        var DEFAULT = this.LOCALS.DEFAULT;
        var ERROR = this.Style.error || "error";
        
        if ( state.init ) this.resetState( state );
        
        stack = state.stack;
        stream = new Stream(null, _stream);
        
        if ( stream.eatSpace() ) 
        {
            state.current = null;
            state.currentToken = T_DEFAULT;
            return DEFAULT;
        }
        
        while ( stack.length )
        {
            token = stack.pop();
            style = token.tokenize(stream, state, this.LOCALS);
            
            // match failed
            if ( false === style )
            {
                // error
                if ( token.ERROR || token.isRequired )
                {
                    // empty the stack
                    state.stack.length = 0;
                    // skip this character
                    stream.next();
                    // generate error
                    state.current = null;
                    state.currentToken = T_ERROR;
                    return ERROR;
                }
                // optional
                else
                {
                    continue;
                }
            }
            // found token
            else
            {
                state.current = token.tokenName;
                return style;
            }
        }
        
        for (i=0; i<numTokens; i++)
        {
            token = this.tokens[i];
            style = token.tokenize(stream, state, this.LOCALS);
            
            // match failed
            if ( false === style )
            {
                // error
                if ( token.ERROR || token.isRequired )
                {
                    // empty the stack
                    state.stack.length = 0;
                    // skip this character
                    stream.next();
                    // generate error
                    state.current = null;
                    state.currentToken = T_ERROR;
                    return ERROR;
                }
                // optional
                else
                {
                    continue;
                }
            }
            // found token
            else
            {
                state.current = token.tokenName;
                return style;
            }
        }
        
        // unknown, bypass
        stream.next();
        state.current = null;
        state.currentToken = T_DEFAULT;
        return DEFAULT;
    }
}
</textarea>
        <p></p>

        <script>
        // <![CDATA[
        
        // 2. parse the grammar into a Codemirror syntax-highlight mode
        var js_mode = CodeMirrorGrammar.getMode(js_grammar);
        
        // 3. register the mode with Codemirror
        CodeMirror.defineMode("js", js_mode);
        
        // use it!
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "js",
            lineNumbers: true,
            matchBrackets: true,
            indentUnit: 4,
            indentWithTabs: false
        });
        editor.setSize(null, 500);
        
        // ]]>
        </script>
    </body>
</html>
