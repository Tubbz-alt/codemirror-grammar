/**
*
*   CodeMirrorGrammar
*   @version: 0.4
*   Transform a grammar specification in JSON format,
*   into a CodeMirror syntax-highlight parser mode
*
*   https://github.com/foo123/codemirror-grammar
*
**/(function(t){var e,n,s="0.4",i=2,r=4,o=8,h=9,u=16,c=32,a=64,l=128,k=256,p=512,f=33,m=34,R=36,g=40,y=48,d=64,O=128,v=4,E=8,T=16,B=32,b=64,S=128,P=256,x=512,w=1024,A=2048,C=4096,L=8192,q={ONEOF:S,EITHER:S,ALL:P,ALLOF:P,ZEROORONE:x,ZEROORMORE:w,ONEORMORE:A},N={BLOCK:b,"ESCAPED-BLOCK":B,SIMPLE:T,GROUP:C,NGRAM:L,"N-GRAM":L},z=Array.prototype.slice,_=(Array.prototype.splice,Array.prototype.concat,Object.prototype.hasOwnProperty),M=Object.prototype.toString,j=function(t,e){t=t||{};for(var n in e)_.call(e,n)&&(t[n]=e[n]);return t},G=function(t,e){var n=function(){},s=e.constructor;return n.prototype=t.prototype,s.prototype=new n,s.prototype.constructor=s,s.prototype=j(s.prototype,e),s},D=function(e){var n=typeof e,s=M.call(e);return"number"==n||e instanceof Number?i:!0===e||!1===e?r:e&&("string"==n||e instanceof String)?1==e.length?h:o:e&&("[object RegExp]"==s||e instanceof RegExp)?u:e&&("[object Array]"==s||e instanceof Array)?c:e&&"[object Object]"==s?a:null===e?l:t===e?k:p},I=function(t,e){return e||c!=D(t)?[t]:t},U=function(t,e){return t=I(t,e),(e||c!=D(t[0]))&&(t=[t]),t},K=function(t){var e,n=D(t);if(a!=n&&c!=n)return t;var s,i={};for(s in t)_.call(t,s)&&(e=D(t[s]),i[s]=a==e?K(t[s]):c==e?t[s].slice():t[s]);return i},F=function(){var t=z.call(arguments),e=t.length;if(1>e)return null;if(2>e)return K(t[0]);var n,s,i,r,h=t.shift(),u=K(h);for(e--,s=0;e>s;s++)if(n=t.shift())for(i in n)_.call(n,i)&&(_.call(h,i)?(r=D(h[i]),a&~o&r&&(u[i]=F(h[i],n[i]))):u[i]=K(n[i]));return u},Z=G(Object,{constructor:function(t,e){e?(this.stream=e,this.string=""+e.string,this.start=e.start,this.pos=e.pos):(this.string=""+t,this.start=this.pos=0)},stream:null,string:"",start:0,pos:0,sol:function(){return 0==this.pos},eol:function(){return this.pos>=this.string.length},matchChar:function(t,e){e=!1!==e;var n=this.string.charAt(this.pos)||"";return t==n?(e&&(this.pos+=1,this.stream&&(this.stream.pos=this.pos)),n):!1},matchStr:function(t,e,n){n=!1!==n;var s=this.pos,i=this.string.charAt(s);if(e.peek[i]){var r=t.length,o=this.string.substr(s,r);if(t==o)return n&&(this.pos+=r,this.stream&&(this.stream.pos=this.pos)),o}return!1},matchRegex:function(t,e,n,s){n=!1!==n,s=s||0;var i=this.pos,r=this.string.charAt(i);if(e.peek&&e.peek[r]||e.negativepeek&&!e.negativepeek[r]){var o=this.string.slice(i).match(t);return!o||o.index>0?!1:(n&&(this.pos+=o[s].length,this.stream&&(this.stream.pos=this.pos)),o)}return!1},skipToEnd:function(){return this.pos=this.string.length,this.stream&&(this.stream.pos=this.pos),this},peek:function(){return this.string.charAt(this.pos)||t},next:function(){if(this.pos<this.string.length){var e=this.string.charAt(this.pos++);return this.stream&&(this.stream.pos=this.pos),e}return t},backUp:function(t){return this.pos-=t,this.stream&&(this.stream.pos=this.pos),this},backTo:function(t){return this.pos=t,this.stream&&(this.stream.pos=this.pos),this},eatSpace:function(){for(var t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.stream&&(this.stream.pos=this.pos),this.pos>t},current:function(){return this.string.slice(this.start,this.pos)},shift:function(){return this.start=this.pos,this}}),$=/([\-\.\*\+\?\^\$\{\}\(\)\|\[\]\/\\])/g,H=function(t,e){return e.length-t.length},V=function(t,e){return o&D(e)&&o&D(t)&&e.length&&e.length<=t.length&&e==t.substr(0,e.length)},J=function(t,e,s){if(!t||i==D(t))return t;var r=e?e.length||0:0;if(r&&e==t.substr(0,r)){var o,h,u,c="^("+t.substr(r)+")";return s[c]||(o=new RegExp(c),u=new n(o).analyze(),h=u.getPeekChars(),Object.keys(h.peek).length||(h.peek=null),Object.keys(h.negativepeek).length||(h.negativepeek=null),s[c]=[o,h]),s[c]}return t},Q=function(t,e){var n,s,i={},r="";for(o==D(e)&&(r=e),n=0,s=t.length;s>n;n++)i[t[n].charAt(0)]=1,t[n]=t[n].replace($,"\\$1");return[new RegExp("^("+t.sort(H).join("|")+")"+r),{peek:i,negativepeek:null},1]},W=G(Object,{constructor:function(t,e,n,s){this.name=t,this.pattern=e,this.key=n||0,this.type=s||y},name:null,pattern:null,peek:null,type:null,key:0,toString:function(){var t="[";return t+="Matcher: "+this.name,t+=", Type: "+this.type,t+=", Pattern: "+(this.pattern?this.pattern.toString():null),t+="]"},match:function(){return[this.key,this.pattern]}}),X=G(W,{constructor:function(t,e,n){this.name=t,this.pattern=e,this.type=f,this.key=n||0},match:function(t,e){var n;return(n=t.matchChar(this.pattern,e))?[this.key,n]:!1}}),Y=G(W,{constructor:function(t,e,n){this.name=t,this.pattern=e,this.peek={peek:{},negativepeek:null},this.peek.peek[""+e.charAt(0)]=1,this.type=m,this.key=n||0},match:function(t,e){var n;return(n=t.matchStr(this.pattern,this.peek,e))?[this.key,n]:!1}}),te=G(W,{constructor:function(t,e,n){this.name=t,this.pattern=e[0],this.peek=e[1],this.isComposite=e[2]||0,this.type=R,this.key=n||0},isComposite:0,match:function(t,e){var n;return(n=t.matchRegex(this.pattern,this.peek,e,this.isComposite))?[this.key,n]:!1}}),ee=G(W,{constructor:function(t,e,n){this.name=t,this.type=g,this.key=n||0},match:function(t,e){return!1!==e&&t.skipToEnd(),[this.key,""]}}),ne=function(t,e,n,s){n=n||0;var u,a=t+"_SimpleMatcher",k=D(e);return i==k?e:(s[a]||(u=r==k?new W(a,e,n):l==k?new ee(a,e,n):h==k?new X(a,e,n):o==k?new Y(a,e,n):c==k?new te(a,e,n):e,s[a]=u),s[a])},se=G(W,{constructor:function(t,e,n){this.name=t,this.matchers=e,this.type=d,this.useOwnKey=!1!==n},matchers:null,useOwnKey:!0,test:function(t){var e,n,s=this.matchers,i=s.length;for(e=0;i>e;e++)if(n=s[e].test(t))return!0;return!1},match:function(t,e){var n,s,i=this.matchers,r=i.length;for(n=0;r>n;n++)if(s=i[n].match(t,e))return this.useOwnKey?[n,s[1]]:s;return!1}}),ie=function(t,e,n,s,i,r){var o,h,u,a,l,k=!1,p=!1,f=t+"_CompoMatcher";if(!r[f]){if(o=I(e),u=o.length,s)for(a=(u>>1)+1,h=0;a>=h;h++){if(c==D(o[h])||c==D(o[u-1-h])){k=!0;break}if(V(o[h],n)||V(o[u-1-h],n)){p=!0;break}}if(!s||k||p){for(h=0;u>h;h++)o[h]=c==D(o[h])?ie(f+"_"+h,o[h],n,s,i,r):ne(f+"_"+h,J(o[h],n,i),h,r);l=o.length>1?new se(f,o):o[0]}else l=ne(f,Q(o,s),0,r);r[f]=l}return r[f]},re=G(W,{constructor:function(t,e,n){this.name=t,this.type=O,this.start=new se(this.name+"_StartMatcher",e,!1),this.pattern=this.start.pattern||null,this.end=n},start:null,end:null,test:function(t){return this.start.test(t)},match:function(t,e){var n=this.start.match(t,e);if(n){var s=this.end[n[0]];return i==D(s)&&(s=new Y(this.name+"_EndMatcher",n[1][s+1])),s}return!1}}),oe=function(t,e,n,s,i){var r,o,h,u,c,a,l,k=t+"_BlockMatcher";if(!i[k]){for(u=[],c=[],r=U(e),o=0,h=r.length;h>o;o++)a=ne(k+"_0_"+o,J(r[o][0],n,s),o,i),l=r[o].length>1?ne(k+"_1_"+o,J(r[o][1],n,s),o,i):a,u.push(a),c.push(l);i[k]=new re(k,u,c)}return i[k]},he=G(Object,{constructor:function(t,e,n,s){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),s&&(this.style=s),this.tokenName=this.name},name:null,token:null,tokenName:null,type:null,style:null,isRequired:!1,ERROR:!1,streamPos:null,stackPos:null,actionBefore:null,actionAfter:null,toString:function(){var t="[";return t+="Tokenizer: "+this.name,t+=", Type: "+this.type,t+=", Token: "+(this.token?this.token.toString():null),t+="]"},required:function(t){return this.isRequired=t?!0:!1,this},pushToken:function(t,e,n){return this.stackPos?t.splice(this.stackPos+(n||0),0,e):t.push(e),this},clone:function(){var t=z.call(arguments);if(t.length){var e=t.shift(),n=t.length,s=new e;s.name=this.name,s.type=this.type,s.isRequired=this.isRequired,s.ERROR=this.ERROR,s.actionBefore=this.actionBefore,s.actionAfter=this.actionAfter;for(var i=0;n>i;i++)s[t[i]]=this[t[i]];return s}return null},tokenize:function(t,e){return this.token.match(t)?(e.currentToken=this.type,this.style):!1}}),ue=G(he,{constructor:function(t,e,n,s,i){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),s&&(this.style=s),this.multiline=!1!==i,this.endBlock=null,this.tokenName=this.name},multiline:!1,endBlock:null,tokenize:function(t,e){var n=!1,s=!1;if(e.inBlock==this.name?(s=!0,this.endBlock=e.endBlock):!e.inBlock&&(this.endBlock=this.token.match(t))&&(s=!0,e.inBlock=this.name,e.endBlock=this.endBlock),s){for(this.stackPos=e.stack.length,n=this.endBlock.match(t);!n&&!t.eol();){if(this.endBlock.match(t)){n=!0;break}t.next()}return n=n||!this.multiline&&t.eol(),n?(e.inBlock=null,e.endBlock=null):this.pushToken(e.stack,this),e.currentToken=this.type,this.style}return e.inBlock=null,e.endBlock=null,!1}}),ce=G(ue,{constructor:function(t,e,n,s,i,r){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),s&&(this.style=s),i&&(this.escape=i||"\\"),r&&(this.multiline=r||!1),this.endBlock=null,this.isEscaped=!1,this.tokenName=this.name},escape:"\\",tokenize:function(t,e){var n="",s=!1,i=!1,r=!1;if(e.inBlock==this.name?(i=!0,this.endBlock=e.endBlock):!e.inBlock&&(this.endBlock=this.token.match(t))&&(i=!0,e.inBlock=this.name,e.endBlock=this.endBlock),i){for(e.inBlock=this.name,this.stackPos=e.stack.length,s=this.endBlock.match(t);!s&&!t.eol();){if(!r&&this.endBlock.match(t)){s=!0;break}n=t.next(),r=!r&&n==this.escape}return s=s||!(r&&this.multiline),s?(e.inBlock=null,e.endBlock=null):this.pushToken(e.stack,this),e.currentToken=this.type,this.style}return e.inBlock=null,e.endBlock=null,!1}}),ae=G(he,{constructor:function(t,e){t&&(this.name=t),e&&(this.type=e),this.tokenName=this.name},tokens:null,buildTokens:function(t){return t&&(this.tokens=I(t),this.token=this.tokens[0]),this}}),le=G(ae,{constructor:function(t,e){this.type=x,t&&(this.name=t),e&&this.buildTokens(e),this.tokenName=this.name},tokenize:function(t,e){this.isRequired=!1,this.ERROR=!1,this.streamPos=t.pos;var n=this.token.tokenize(t,e);return token.ERROR&&t.backTo(this.streamPos),n}}),ke=G(ae,{constructor:function(t,e){this.type=w,t&&(this.name=t),e&&this.buildTokens(e),this.tokenName=this.name},tokenize:function(t,e,n){var s,i,r,o=this.tokens.length,h=0;for(this.isRequired=!1,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,s=0;o>s;s++){if(i=this.tokens[s],r=i.tokenize(t,e,n),!1!==r)return this.pushToken(e.stack,this),r;i.ERROR&&(h++,t.backTo(this.streamPos))}return!1}}),pe=G(ae,{constructor:function(t,e){this.type=A,t&&(this.name=t),e&&this.buildTokens(e),this.foundOne=!1,this.tokenName=this.name},foundOne:!1,tokenize:function(t,e,n){var s,i,r,o=this.tokens.length,h=0,u=0;for(this.isRequired=!this.foundOne,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,r=0;o>r;r++){if(i=this.tokens[r],s=i.tokenize(t,e,n),h+=i.isRequired?1:0,!1!==s)return this.foundOne=!0,this.isRequired=!1,this.ERROR=!1,this.pushToken(e.stack,this.clone(pe,"tokens","foundOne")),this.foundOne=!1,s;i.ERROR&&(u++,t.backTo(this.streamPos))}return this.ERROR=this.foundOne?!1:!0,!1}}),fe=G(ae,{constructor:function(t,e){this.type=S,t&&(this.name=t),e&&this.buildTokens(e),this.tokenName=this.name},tokenize:function(t,e,n){var s,i,r,o=this.tokens.length,h=0,u=0;for(this.isRequired=!0,this.ERROR=!1,this.streamPos=t.pos,r=0;o>r;r++){if(i=this.tokens[r],s=i.tokenize(t,e,n),h+=i.isRequired?1:0,!1!==s)return s;i.ERROR&&(u++,t.backTo(this.streamPos))}return this.isRequired=h>0?!0:!1,this.ERROR=o==u&&h>0?!0:!1,!1}}),me=G(ae,{constructor:function(t,e){this.type=P,t&&(this.name=t),e&&this.buildTokens(e),this.tokenName=this.name},tokenize:function(t,e,n){var s,i,r=this.tokens.length,o=!1,h=0;if(this.isRequired=!0,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,s=this.tokens[0],i=s.required(!0).tokenize(t,e,n),!1!==i){this.stackPos=e.stack.length;for(var u=r-1;u>0;u--)this.pushToken(e.stack,this.tokens[u].required(!0),r-u+h);o=i}else s.ERROR?(this.ERROR=!0,t.backTo(this.streamPos)):s.isRequired&&(this.ERROR=!0);return o}}),Re=G(ae,{constructor:function(t,e){this.type=L,t&&(this.name=t),e&&this.buildTokens(e),this.tokenName=this.tokens[0].name},tokenize:function(t,e,n){var s,i,r=this.tokens.length,o=!1,h=0;if(this.isRequired=!1,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,s=this.tokens[0],i=s.required(!1).tokenize(t,e,n),!1!==i){this.stackPos=e.stack.length;for(var u=r-1;u>0;u--)this.pushToken(e.stack,this.tokens[u].required(!0),r-u+h);o=i}else s.ERROR&&t.backTo(this.streamPos);return o}}),ge=function(t,n,s,i,r,o,h,u,c){var a,l,k,p,f,m=null;if(!c[t]){if(a=i[t]||r[t]||null)if(l=a.type||"simple",l=N[l.toUpperCase()],f=a.action||null,b==l)m=new ue(t,oe(t,a.tokens.slice(),n,h,u),l,o[t]||e,a.multiline);else if(B==l)m=new ce(t,oe(t,a.tokens.slice(),n,h,u),l,o[t]||e,a.escape||"\\",a.multiline||!1);else if(T==l)m=new he(t,ie(t,a.tokens.slice(),n,s[t],h,u),l,o[t]||e);else if(C==l){k=q[a.match.toUpperCase()],p=I(a.tokens).slice();for(var R=0,g=p.length;g>R;R++)p[R]=ge(p[R],n,s,i,r,o,h,u,c);m=x==k?new le(t,p):w==k?new ke(t,p):A==k?new pe(t,p):S==k?new fe(t,p):new me(t,p)}else if(L==l){m=U(I(a.tokens).slice()).slice();for(var R=0,g=m.length;g>R;R++){for(var y=m[R],d=0,O=y.length;O>d;d++)y[d]=ge(y[d],n,s,i,r,o,h,u,c);m[R]=new Re(t+"_NGRAM_"+R,y)}}c[t]=m}return c[t]},ye=G(Object,{constructor:function(t,e){this.LOCALS=e,this.Style=t.Style||{},this.tokens=t.Parser||[]},LOCALS:null,Style:null,tokens:null,resetState:function(t){return t=t||{},t.stack=[],t.inBlock=null,t.current=null,t.currentToken=E,t.init=null,t},copyState:function(t){var e={};for(var n in t)e[n]=c==D(t[n])?t[n].slice():t[n];return e},getToken:function(t,e){var n,s,i,r,o,h=this.tokens.length,u=this.LOCALS.DEFAULT,c=this.Style.error||"error";if(e.init&&this.resetState(e),o=e.stack,r=new Z(null,t),r.eatSpace())return e.current=null,e.currentToken=E,u;for(;o.length;){if(s=o.pop(),i=s.tokenize(r,e,this.LOCALS),!1!==i)return e.current=s.tokenName,i;if(s.ERROR||s.isRequired)return e.stack.length=0,r.next(),e.current=null,e.currentToken=v,c}for(n=0;h>n;n++){if(s=this.tokens[n],i=s.tokenize(r,e,this.LOCALS),!1!==i)return e.current=s.tokenName,i;if(s.ERROR||s.isRequired)return e.stack.length=0,r.next(),e.current=null,e.currentToken=v,c}return r.next(),e.current=null,e.currentToken=E,u}}),de=function(t,e){return new ye(t,e)},Oe=function(){return function(){return CodeMirror.Pass}},ve={RegExpID:null,RegExpGroups:null,Style:{error:"error"},Lex:null,Syntax:null,Parser:null},Ee=function(t){var e,n,s,i,r,o,h,u,a,l,k,p={},f={},m={};if(t.__parsed)return t;for(t=F(t,ve),e=t.RegExpID||null,t.RegExpID=null,delete t.RegExpID,n=t.RegExpGroups||{},t.RegExpGroups=null,delete t.RegExpGroups,h=t.Lex||{},t.Lex=null,delete t.Lex,u=t.Syntax||{},t.Syntax=null,delete t.Syntax,o=t.Style||{},r=t.Parser||[],i=r.length,s=[],a=0;i>a;a++)l=r[a],k=ge(l,e,n,h,u,o,p,f,m)||null,k&&(c==D(k)?s=s.concat(k):s.push(k));return t.Parser=s,t.Style=o,t.__parsed=!0,t},Te={VERSION:s,init:function(t){n=t},extend:F,parse:Ee,getMode:function(t,n){e=null,t=Ee(t);var s={DEFAULT:n||e},i=de(t,s),r=function(e,n){return s.conf=e,s.parserConf=n,{startState:function(){return{init:1}},electricChars:t.electricChars?t.electricChars:!1,copyState:function(t){return function(e){return t.copyState(e)}}(i),token:function(t){return function(e,n){return t.getToken(e,n)}}(i),indent:Oe(s)}};return r}};"undefined"!=typeof module&&module.exports?module.exports=Te:"undefined"!=typeof exports?exports=Te:this.CodeMirrorGrammar=Te}).call(this);