/**
*
*   CodeMirrorGrammar
*   @version: 0.3
*   Transform a grammar specification in JSON format,
*   into a CodeMirror syntax-highlight parser mode
*
*   https://github.com/foo123/codemirror-grammar
*
**/(function(t,e){var n,i="0.3",s=2,r=4,o=8,h=9,u=16,c=32,l=64,a=128,k=256,p=512,f=33,R=34,d=36,y=40,g=48,m=64,O=128,v=4,E=8,b=16,T=32,B=64,x=128,P=256,q=512,w=1024,S=2048,z=4096,A=8192,_={ONEOF:x,EITHER:x,ALL:P,ALLOF:P,ZEROORONE:q,ZEROORMORE:w,ONEORMORE:S},M={BLOCK:B,"ESCAPED-BLOCK":T,SIMPLE:b,GROUP:z,NGRAM:A,"N-GRAM":A},L=Array.prototype.slice,j=(Array.prototype.splice,Array.prototype.concat,Object.prototype.hasOwnProperty),C=Object.prototype.toString,G=function(t,e){t=t||{};for(var n in e)j.call(e,n)&&(t[n]=e[n]);return t},N=function(t,e){var n=function(){},i=e.constructor;return n.prototype=t.prototype,i.prototype=new n,i.prototype.constructor=i,i.prototype=G(i.prototype,e),i},D=function(t){var n=typeof t,i=C.call(t);return"number"==n||t instanceof Number?s:!0===t||!1===t?r:t&&("string"==n||t instanceof String)?1==t.length?h:o:t&&("[object RegExp]"==i||t instanceof RegExp)?u:t&&("[object Array]"==i||t instanceof Array)?c:t&&"[object Object]"==i?l:null===t?a:e===t?k:p},I=function(t,e){return e||c!=D(t)?[t]:t},K=function(t,e){return t=I(t,e),(e||c!=D(t[0]))&&(t=[t]),t},U=function(t){var e,n=D(t);if(l!=n&&c!=n)return t;var i,s={};for(i in t)j.call(t,i)&&(e=D(t[i]),s[i]=l==e?U(t[i]):c==e?t[i].slice():t[i]);return s},F=function(){var t=L.call(arguments),e=t.length;if(1>e)return null;if(2>e)return U(t[0]);var n,i,s,r,h=t.shift(),u=U(h);for(e--,i=0;e>i;i++)if(n=t.shift())for(s in n)j.call(n,s)&&(j.call(h,s)?(r=D(h[s]),l&~o&r&&(u[s]=F(h[s],n[s]))):u[s]=U(n[s]));return u},Z={RegExpID:null,RegExpGroups:null,Style:{error:"error"},Lex:null,Syntax:null,Parser:null},$=/([\-\.\*\+\?\^\$\{\}\(\)\|\[\]\/\\])/g,H=function(t,e){return e.length-t.length},V=function(t,e){return o&D(e)&&o&D(t)&&e.length&&e.length<=t.length&&e==t.substr(0,e.length)},J=function(t,e,i){if(!t||s==D(t))return t;var r=e?e.length||0:0;if(r&&e==t.substr(0,r)){var o,h,u,c="^("+t.substr(r)+")";return i[c]||(o=new RegExp(c),u=new n(o).analyze(),h=u.getPeekChars(),Object.keys(h.peek).length||(h.peek=null),Object.keys(h.negativepeek).length||(h.negativepeek=null),i[c]=[o,h]),i[c]}return t},Q=function(t){var e,n,i={};for(e=0,n=t.length;n>e;e++)i[t[e].charAt(0)]=1,t[e]=t[e].replace($,"\\$1");return[new RegExp("^(("+t.sort(H).join(")|(")+"))\\b"),{peek:i,negativepeek:null}]},W=N(Object,{constructor:function(t,e,n,i){this.name=t,this.pattern=e,this.key=n||0,this.type=i||g},name:null,pattern:null,peek:null,type:null,key:0,toString:function(){var t="[";return t+="Matcher: "+this.name,t+=", Type: "+this.type,t+=", Pattern: "+(this.pattern?this.pattern.toString():null),t+="]"},match:function(){return[this.key,this.pattern]}}),X=N(W,{constructor:function(t,e,n){this.name=t,this.pattern=e,this.type=f,this.key=n||0},match:function(t,e){e=!1!==e;var n=t.string.charAt(t.pos)||"";return this.pattern==n?(e&&(t.pos+=1),[this.key,n]):!1}}),Y=N(W,{constructor:function(t,e,n){this.name=t,this.pattern=e,this.peek={peek:{},negativepeek:null},this.peek.peek[""+e.charAt(0)]=1,this.type=R,this.key=n||0},match:function(t,e){e=!1!==e;var n=t.pos,i=t.string.charAt(n);if(this.peek.peek[i]){var s=this.pattern.length,r=t.string.substr(n,s);if(this.pattern==r)return e&&(t.pos+=s),[this.key,r]}return!1}}),te=N(W,{constructor:function(t,e,n){this.name=t,this.pattern=e[0],this.peek=e[1],this.type=d,this.key=n||0},match:function(t,e){e=!1!==e;var n=t.pos,i=t.string.charAt(n);if(this.peek.peek&&this.peek.peek[i]||this.peek.negativepeek&&!this.peek.negativepeek[i]){var s=t.string.slice(n).match(this.pattern);return!s||s.index>0?!1:(e&&(t.pos+=s[0].length),[this.key,s])}return!1}}),ee=N(W,{constructor:function(t,e,n){this.name=t,this.type=y,this.key=n||0},match:function(t,e){return!1!==e&&(t.pos=t.string.length),[this.key,""]}}),ne=function(t,e,n,i){n=n||0;var u,l=t+"_SimpleMatcher",k=D(e);return s==k?e:(i[l]||(u=r==k?new W(l,e,n):a==k?new ee(l,e,n):h==k?new X(l,e,n):o==k?new Y(l,e,n):c==k?new te(l,e,n):e,i[l]=u),i[l])},ie=N(W,{constructor:function(t,e,n){this.name=t,this.matchers=e,this.type=m,this.useOwnKey=!1!==n},matchers:null,useOwnKey:!0,match:function(t,e){var n,i,s=this.matchers,r=s.length;for(n=0;r>n;n++)if(i=s[n].match(t,e))return this.useOwnKey?[n,i[1]]:i;return!1}}),se=function(t,e,n,i,s,r){var o,h,u,l,a,k=!1,p=!1,f=t+"_CompoMatcher";if(!r[f]){if(o=I(e),u=o.length,i)for(l=(u>>1)+1,h=0;l>=h;h++){if(c==D(o[h])||c==D(o[u-1-h])){k=!0;break}if(V(o[h],n)||V(o[u-1-h],n)){p=!0;break}}if(!i||k||p){for(h=0;u>h;h++)o[h]=c==D(o[h])?se(f+"_"+h,o[h],n,i,s,r):ne(f+"_"+h,J(o[h],n,s),h,r);a=o.length>1?new ie(f,o):o[0]}else a=ne(f,Q(o),0,r);r[f]=a}return r[f]},re=N(W,{constructor:function(t,e,n){this.name=t,this.type=O,this.start=new ie(this.name+"_StartMatcher",e,!1),this.pattern=this.start.pattern||null,this.end=n},start:null,end:null,match:function(t,e){var n=this.start.match(t,e);if(n){var i=this.end[n[0]];return s==D(i)&&(i=new Y(this.name+"_EndMatcher",n[1][i+1])),i}return!1}}),oe=function(t,e,n,i,s){var r,o,h,u,c,l,a,k=t+"_BlockMatcher";if(!s[k]){for(u=[],c=[],r=K(e),o=0,h=r.length;h>o;o++)l=ne(k+"_0_"+o,J(r[o][0],n,i),o,s),a=r[o].length>1?ne(k+"_1_"+o,J(r[o][1],n,i),o,s):l,u.push(l),c.push(a);s[k]=new re(k,u,c)}return s[k]},he=N(Object,{constructor:function(t,e,n,i){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),i&&(this.style=i)},name:null,token:null,type:null,style:null,isRequired:!1,ERROR:!1,streamPos:null,stackPos:null,toString:function(){var t="[";return t+="Tokenizer: "+this.name,t+=", Type: "+this.type,t+=", Token: "+(this.token?this.token.toString():null),t+="]"},required:function(t){return this.isRequired=t?!0:!1,this},backTrack:function(t){return t.pos-=t.pos-this.streamPos,this},pushToken:function(t,e,n){return this.stackPos?t.splice(this.stackPos+(n||0),0,e):t.push(e),this},clone:function(){var t=L.call(arguments);if(t.length){var e=t.shift(),n=t.length,i=new e;i.name=this.name,i.type=this.type,i.isRequired=this.isRequired,i.ERROR=this.ERROR;for(var s=0;n>s;s++)i[t[s]]=this[t[s]];return i}return null},tokenize:function(t,e){return this.token.match(t)?(e.currentToken=this.type,this.style):!1}}),ue=N(he,{constructor:function(t,e,n,i){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),i&&(this.style=i),this.endBlock=null},endBlock:null,tokenize:function(t,e){var n=!1,i=!1;if(e.inBlock==this.name?(i=!0,this.endBlock=e.endBlock):!e.inBlock&&(this.endBlock=this.token.match(t))&&(i=!0,e.inBlock=this.name,e.endBlock=this.endBlock),i){for(this.stackPos=e.stack.length,n=this.endBlock.match(t);!n&&!t.eol();){if(this.endBlock.match(t)){n=!0;break}t.next()}return n?(e.inBlock=null,e.endBlock=null):this.pushToken(e.stack,this),e.currentToken=this.type,this.style}return e.inBlock=null,e.endBlock=null,!1}}),ce=N(ue,{constructor:function(t,e,n,i,s,r){t&&(this.name=t),e&&(this.token=e),n&&(this.type=n),i&&(this.style=i),s&&(this.escape=s||"\\"),r&&(this.multiline=r||!1),this.endBlock=null,this.isEscaped=!1},escape:"\\",multiline:!1,tokenize:function(t,e){var n="",i=!1,s=!1,r=!1;if(e.inBlock==this.name?(s=!0,this.endBlock=e.endBlock):!e.inBlock&&(this.endBlock=this.token.match(t))&&(s=!0,e.inBlock=this.name,e.endBlock=this.endBlock),s){for(e.inBlock=this.name,this.stackPos=e.stack.length,i=this.endBlock.match(t);!i&&!t.eol();){if(!r&&this.endBlock.match(t)){i=!0;break}n=t.next(),r=!r&&n==this.escape}return i=i||!(r&&this.multiline),i?(e.inBlock=null,e.endBlock=null):this.pushToken(e.stack,this),e.currentToken=this.type,this.style}return e.inBlock=null,e.endBlock=null,!1}}),le=N(he,{constructor:function(t,e){t&&(this.name=t),e&&(this.type=e)},tokens:null,buildTokens:function(t){return t&&(this.tokens=I(t),this.token=this.tokens[0]),this}}),ae=N(le,{constructor:function(t,e){this.type=q,t&&(this.name=t),e&&this.buildTokens(e)},tokenize:function(t,e){this.isRequired=!1,this.ERROR=!1,this.streamPos=t.pos;var n=this.token.tokenize(t,e);return token.ERROR&&this.backTrack(t),n}}),ke=N(le,{constructor:function(t,e){this.type=w,t&&(this.name=t),e&&this.buildTokens(e)},tokenize:function(t,e){var n,i,s,r=this.tokens.length,o=0;for(this.isRequired=!1,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,n=0;r>n;n++){if(i=this.tokens[n],s=i.tokenize(t,e),!1!==s)return this.pushToken(e.stack,this),s;i.ERROR&&(o++,this.backTrack(t))}return!1}}),pe=N(le,{constructor:function(t,e){this.type=S,t&&(this.name=t),e&&this.buildTokens(e),this.foundOne=!1},foundOne:!1,tokenize:function(t,e){var n,i,s,r=this.tokens.length,o=0,h=0;for(this.isRequired=!this.foundOne,this.ERROR=!1,this.streamPos=t.pos,this.stackPos=e.stack.length,s=0;r>s;s++){if(i=this.tokens[s],n=i.tokenize(t,e),o+=i.isRequired?1:0,!1!==n)return this.foundOne=!0,this.isRequired=!1,this.ERROR=!1,this.pushToken(e.stack,this.clone(pe,"tokens","foundOne")),this.foundOne=!1,n;i.ERROR&&(h++,this.backTrack(t))}return this.ERROR=this.foundOne?!1:!0,!1}}),fe=N(le,{constructor:function(t,e){this.type=x,t&&(this.name=t),e&&this.buildTokens(e)},tokenize:function(t,e){var n,i,s,r=this.tokens.length,o=0,h=0;for(this.isRequired=!0,this.ERROR=!1,this.streamPos=t.pos,s=0;r>s;s++){if(i=this.tokens[s],n=i.tokenize(t,e),o+=i.isRequired?1:0,!1!==n)return n;i.ERROR&&(h++,this.backTrack(t))}return this.isRequired=o>0?!0:!1,this.ERROR=r==h&&o>0?!0:!1,!1}}),Re=N(le,{constructor:function(t,e){this.type=P,t&&(this.name=t),e&&this.buildTokens(e),this.inSequence=0},inSequence:0,tokenize:function(t,e){var n,i,s=this.tokens.length,r=!1;if(this.isRequired=!0,this.ERROR=!1,this.inSequence=0,this.streamPos=t.pos,this.stackPos=e.stack.length,n=this.tokens[0],i=n.required(!0).tokenize(t,e),!1!==i){this.stackPos=e.stack.length;for(var o=s-1;o>0;o--)this.pushToken(e.stack,this.tokens[o].required(!0),s-o);r=i}else n.ERROR?(this.ERROR=!0,this.backTrack(t)):n.isRequired&&(this.ERROR=!0);return r}}),de=N(le,{constructor:function(t,e){this.type=A,t&&(this.name=t),e&&this.buildTokens(e),this.inSequence=0},inSequence:0,tokenize:function(t,e){var n,i,s=this.tokens.length,r=!1;if(this.isRequired=!1,this.ERROR=!1,this.inSequence=0,this.streamPos=t.pos,this.stackPos=e.stack.length,n=this.tokens[0],i=n.required(!1).tokenize(t,e),!1!==i){this.stackPos=e.stack.length;for(var o=s-1;o>0;o--)this.pushToken(e.stack,this.tokens[o].required(!0),s-o);r=i}else n.ERROR&&this.backTrack(t);return r}}),ye=function(t,e,n,i,s,r,o,h,u){var c,l,a,k,p=null;if(!u[t]){if(c=i[t]||s[t]||null)if(l=c.type,l=M[l.toUpperCase()],B==l)p=new ue(t,oe(t,c.tokens.slice(),e,o,h),l,r[t]||null);else if(T==l)p=new ce(t,oe(t,c.tokens.slice(),e,o,h),l,r[t]||null,c.escape||"\\",c.multiline||!1);else if(b==l)p=new he(t,se(t,c.tokens.slice(),e,n[t],o,h),l,r[t]||null);else if(z==l){a=_[c.match.toUpperCase()],k=I(c.tokens).slice();for(var f=0,R=k.length;R>f;f++)k[f]=ye(k[f],e,n,i,s,r,o,h,u);p=q==a?new ae(t,k):w==a?new ke(t,k):S==a?new pe(t,k):x==a?new fe(t,k):new Re(t,k)}else if(A==l){p=K(I(c.tokens).slice()).slice();for(var f=0,R=p.length;R>f;f++){for(var d=p[f],y=0,g=d.length;g>y;y++)d[y]=ye(d[y],e,n,i,s,r,o,h,u);p[f]=new de(t+"_NGRAM_"+f,d)}}u[t]=p}return u[t]},ge=function(t,e){var n=e.DEFAULT,i=t.Style||{},s=i.error||null,r=t.Parser||[],o=r.length,h=function(t,e){var i,h,u,c;if(c=e.stack=e.stack||[],t.eatSpace())return e.currentToken=E,n;for(;c.length;){if(h=c.pop(),u=h.tokenize(t,e),!1!==u)return u;if(h.ERROR||h.isRequired)return e.stack.length=0,t.next(),e.currentToken=v,s}for(i=0;o>i;i++){if(h=r[i],u=h.tokenize(t,e),!1!==u)return u;if(h.ERROR||h.isRequired)return e.stack.length=0,t.next(),e.currentToken=v,s}return t.next(),e.currentToken=E,n};return h},me=function(){return function(){return CodeMirror.Pass}},Oe=function(t){var e,n,i,s,r,o,h,u,l,a,k,p={},f={},R={};if(t.__parsed)return t;for(t=F(t,Z),e=t.RegExpID||null,t.RegExpID=null,delete t.RegExpID,n=t.RegExpGroups||{},t.RegExpGroups=null,delete t.RegExpGroups,h=t.Lex||{},t.Lex=null,delete t.Lex,u=t.Syntax||{},t.Syntax=null,delete t.Syntax,o=t.Style||{},r=t.Parser||[],s=r.length,i=[],l=0;s>l;l++)a=r[l],k=ye(a,e,n,h,u,o,p,f,R)||null,k&&(c==D(k)?i=i.concat(k):i.push(k));return t.Parser=i,t.Style=o,t.__parsed=!0,t},ve={VERSION:i,init:function(t){n=t},extend:F,parse:Oe,getMode:function(t,e){t=Oe(t);var n,i,s={DEFAULT:e||null};return n=ge(t,s),i=me(s),function(t,e){return s.conf=t,s.parserConf=e,{startState:function(t){return s.basecolumn=t||0,{stack:null,currentToken:E}},token:n,indent:i}}}};"undefined"!=typeof module&&module.exports?module.exports=ve:"undefined"!=typeof exports?exports=ve:this.CodeMirrorGrammar=ve}).call(this);